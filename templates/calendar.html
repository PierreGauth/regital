<style>

.calendar {
  font: 16px sans-serif;
  shape-rendering: crispEdges;
}

.badge {
 	font: 16px sans-serif;
	font-weight:bold;
}

.day {
  fill: #fff;
  stroke: #ccc;
}

.filled {
	cursor: pointer;
}

.month {
  fill: none;
  stroke: #000;
  stroke-width: 2px;
}

/*.RdYlGn .q0-11{fill:rgb(165,0,38)}
.RdYlGn .q1-11{fill:rgb(215,48,39)}
.RdYlGn .q2-11{fill:rgb(244,109,67)}
.RdYlGn .q3-11{fill:rgb(253,174,97)}
.RdYlGn .q4-11{fill:rgb(254,224,139)}
.RdYlGn .q5-11{fill:rgb(255,255,191)}
.RdYlGn .q6-11{fill:rgb(217,239,139)}
.RdYlGn .q7-11{fill:rgb(166,217,106)}
.RdYlGn .q8-11{fill:rgb(102,189,99)}
.RdYlGn .q9-11{fill:rgb(26,152,80)}*/
.RdYlGn .filled{fill:rgb(20,100,200)}

.vertical .carousel-inner {
  height: 100%;
}

.carousel.vertical .item {
  -webkit-transition: 0.6s ease-in-out top;
     -moz-transition: 0.6s ease-in-out top;
      -ms-transition: 0.6s ease-in-out top;
       -o-transition: 0.6s ease-in-out top;
          transition: 0.6s ease-in-out top;
}

.carousel.vertical .active {
  top: 0;
}

.carousel.vertical .next {
  top: 400px;
}

.carousel.vertical .prev {
  top: -400px;
}

.carousel.vertical .next.left,
.carousel.vertical .prev.right {
  top: 0;
}

.carousel.vertical .active.left {
  top: -400px;
}

.carousel.vertical .active.right {
  top: 400px;
}

.carousel.vertical .item {
    left: 0;
}

.carousel {
  margin-bottom: 60px;
}

.carousel-caption {
  z-index: 10;
}

.carousel img {
  position: absolute;
  top: 0;
  left: 0;
}

.right-inner-addon {
    position: relative;
}
.right-inner-addon input {
    padding-right: 30px;
		width: 150px;    
}
.right-inner-addon button {
    position: absolute;
    right: 0px;
    padding: 7px 30px;
		width: 50px; 
		height: 30px;
}

#carousel-calendar {
	position: absolute;
	margin: -100px 1%;
	overflow:auto;
	height:750px;
	z-index:0;
}

.tooltip {
	position : absolute;
	pointer-events : none;
}
</style>

<div width="100%" style="text-align:center;position:relative;z-index:1;">
	<div class="btn-group" style="float:left;">
		<button type='button' class="btn btn-default btn-sm" onclick='prevSlide();'>
			<a class="glyphicon glyphicon-chevron-up"></a></button>
	  <button type='button' class="btn btn-default btn-sm" onclick='nextSlide();'>
			<a class="glyphicon glyphicon-chevron-down"></a></button>
	</div>
	<div class="btn-group">
	  <button type='button' class="btn btn-default btn-sm" onclick='goToSlide(1700);'><a>1700</a></button>
		<button type='button' class="btn btn-default btn-sm" onclick='goToSlide(1710);'><a>1710</a></button>
		<button type='button' class="btn btn-default btn-sm" onclick='goToSlide(1720);'><a>1720</a></button>
		<button type='button' class="btn btn-default btn-sm" onclick='goToSlide(1730);'><a>1730</a></button>
		<button type='button' class="btn btn-default btn-sm" onclick='goToSlide(1740);'><a>1740</a></button>
		<button type='button' class="btn btn-default btn-sm" onclick='goToSlide(1750);'><a>1750</a></button>
		<button type='button' class="btn btn-default btn-sm" onclick='goToSlide(1760);'><a>1760</a></button>
		<button type='button' class="btn btn-default btn-sm" onclick='goToSlide(1770);'><a>1770</a></button>
		<button type='button' class="btn btn-default btn-sm" onclick='goToSlide(1780);'><a>1780</a></button>
		<button type='button' class="btn btn-default btn-sm" onclick='goToSlide(1790);'><a>1790</a></button>
	</div>
	<form class="right-inner-addon" action="" method="get" onsubmit="return goToSlide(-1);" style="float:right;">
    <button class="btn btn-default btn-sm" type="submit"><a class="glyphicon glyphicon-search"></a></button>
    <input type="number" class="form-control input-sm" placeholder="Année" id='searchYear'/>
	</form>
</div>
<br/>
<div style="position:relative;z-index:1;opacity:0.75;overflow:auto;width:960px;">
	<span class="badge" style="margin-left:75px;"> J </span>
	<span class="badge" style="margin-left:37px;"> F </span>
	<span class="badge" style="margin-left:37px;"> M </span>
	<span class="badge" style="margin-left:37px;"> M </span>
	<span class="badge" style="margin-left:37px;"> A </span>
	<span class="badge" style="margin-left:37px;"> J </span>
	<span class="badge" style="margin-left:37px;"> J </span>
	<span class="badge" style="margin-left:37px;"> A </span>
	<span class="badge" style="margin-left:37px;"> S </span>
	<span class="badge" style="margin-left:37px;"> O </span>
	<span class="badge" style="margin-left:37px;"> N </span>
	<span class="badge" style="margin-left:37px;"> D </span>
</div>

<div id="carousel-calendar" class="carousel slide vertical" data-ride="carousel" data-interval="0">
	<div id="toolTipsArea" style="position:relative;z-index:1;opacity:0.5;"></div>
  <div id="slideList" class="carousel-inner">
		<div class="item calendar calendar1697"></div>
		<div class="item active calendar calendar1700"></div> 
		<div class="item calendar calendar1703"></div>
  </div>
 	<div id="load_calendar"><div class="progress progress-striped active"><br/><br/><br/>
		<div class="progress-bar"  role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width: 100%"></div>
	</div></div>
	
	<img src='/static/images/degradeHaut.png' width="960px" height="160px" style="margin-top:0px;"/>
	<img src='/static/images/degradeBas.png' width="100%" height="150px" style="margin-top:575px;"/>	
	
</div>

<div style="margin-top:525px;"></div>

<script src="/static/d3js/d3.min.js"></script>
<script>

var minDate = 1697;
var maxDate = 1703;
var currentDate = 1700;

var width = 960,
    height = 136,
    cellSize = 17;

	var day = d3.time.format("%w"),
    week = d3.time.format("%U"),
		year = d3.time.format("%Y"),
    percent = d3.format(".1%"),
    format = d3.time.format("%Y-%m-%d");

	var color = d3.scale.quantize()
    .domain([-.05, .05])
    .range(d3.range(11).map(function(d) { return "filled"; }));

function createCalendar(from, to, balise)
{
	var svg = d3.select(balise).selectAll("svg")
    .data(d3.range(from, to))
  .enter().append("svg")
    .attr("width", width)
    .attr("height", height)
    .attr("class", "RdYlGn")
  .append("g")
    .attr("transform", "translate(" + ((width - cellSize * 53) / 2) + "," + (height - cellSize * 7 - 1) + ")");

	svg.append("text")
    .attr("transform", "translate(-6," + cellSize * 3.5 + ")rotate(-90)")
    .style("text-anchor", "middle")
    .text(function(d) { return d; });

	var rect = svg.selectAll(".day")
    .data(function(d) { return d3.time.days(new Date(d, 0, 1), new Date(d + 1, 0, 1)); })
  	.enter().append("rect")
    .attr("class", "day")
    .attr("onclick", function(d) { return "clickDay(\""+format(d)+"\");"; })
    .attr("width", cellSize)
    .attr("height", cellSize)
    .attr("x", function(d) { return week(d) * cellSize; })
    .attr("y", function(d) { return day(d) * cellSize; })
		.attr("yearPosition", function(d) { return year(d) - currentDate; })
		.attr("onmouseover", "myToolType();")
		.attr("onmouseout", "supprToolType();")
		.attr("title", function(d) { return format(d); })
    .datum(format);

	svg.selectAll(".month")
    .data(function(d) { return d3.time.months(new Date(d, 0, 1), new Date(d + 1, 0, 1)); })
  .enter().append("path")
    .attr("class", "month")
    .attr("d", monthPath);
		
	var data = d3.nest()
    .key(function(d) { return d.Date; })
    .rollup(function(d) { return d[0].Exist; })
    .map({{list_soirees|safe}});

  rect.filter(function(d) { return d in data; })
      .attr("class", function(d) { return "day " + color(data[d]); })
    	.select("title")
      .text(function(d) { return d + ": " + percent(data[d]); });
}

function monthPath(t0) {
  var t1 = new Date(t0.getFullYear(), t0.getMonth() + 1, 0),
      d0 = +day(t0), w0 = +week(t0),
      d1 = +day(t1), w1 = +week(t1);
  return "M" + (w0 + 1) * cellSize + "," + d0 * cellSize
      + "H" + w0 * cellSize + "V" + 7 * cellSize
      + "H" + w1 * cellSize + "V" + (d1 + 1) * cellSize
      + "H" + (w1 + 1) * cellSize + "V" + 0
      + "H" + (w0 + 1) * cellSize + "Z";
}

function nextSlide() {
	currentDate += 3;
	if(currentDate >= maxDate) {
		maxDate += 3;
		slides = window.document.getElementById('slideList').innerHTML;
		window.document.getElementById('slideList').innerHTML = slides + '<div class="item calendar calendar'+maxDate+'"></div>';	
		createCalendar(maxDate-1,maxDate+4, ".calendar"+maxDate);
	}	
	$('#carousel-calendar').carousel('next');
}

function prevSlide() {
	currentDate -= 3;
	if(currentDate <= minDate) {
		minDate -= 3;
		slides = window.document.getElementById('slideList').innerHTML;
		window.document.getElementById('slideList').innerHTML = '<div class="item calendar calendar'+minDate+'"></div>' + slides;
		createCalendar(minDate-4,minDate+1, ".calendar"+minDate);
	}	
	$('#carousel-calendar').carousel('prev');
}

function goToSlide(newDate) {

	if(newDate == -1) {
		newDate = parseInt(window.document.getElementById('searchYear').value);
	}
	
	if(newDate != "") {
		currentDate = newDate;
		if(currentDate <= minDate || currentDate >= maxDate) {
		
			minDate = currentDate - 3;
			maxDate = currentDate + 3;
			
			window.document.getElementById('slideList').innerHTML = '<div class="item calendar calendar'+minDate+' active"></div>'
				+ '<div class="item calendar calendar'+currentDate+'"></div>'
				+ '<div class="item calendar calendar'+maxDate+'"></div>';
				
			createCalendar(currentDate-1,currentDate+4, ".calendar"+currentDate);
			createCalendar(minDate-4,minDate+1, ".calendar"+minDate);
			createCalendar(maxDate-1,maxDate+4, ".calendar"+maxDate);
		}
		$('#carousel-calendar').carousel(1);
	}
	return false;
}

function myToolType() {
	rectEl = myToolType.caller.arguments[0].target;
	x = parseInt(rectEl.getAttribute('x'));
	y = parseInt(rectEl.getAttribute('y')) + (17*8)*(parseInt(rectEl.getAttribute('yearPosition'))+1) - (cellSize / 2);
	message = "" + rectEl.getAttribute('title');	
	window.document.getElementById('toolTipsArea').innerHTML='<div class="tooltip fade top in" style="top: '+y+'px; left: '+x+'px; display: block;"><div class="tooltip-arrow"></div><div class="tooltip-inner">'+message+'</div></div>';
}

function supprToolType() {
	window.document.getElementById('toolTipsArea').innerHTML='';
}

function clickDay(date) {	
	if(clickDay.caller.arguments[0].target.getAttribute('class') == 'day filled') {
		window.location.href= "/soirees/" + date; 
	}
}

$(function() {
	createCalendar(1699,1704, ".calendar1700");
	window.document.getElementById('load_calendar').innerHTML='';
	createCalendar(1696,1701, ".calendar1697");
	createCalendar(1702,1707, ".calendar1703");
});

</script>